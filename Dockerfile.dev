FROM node:24-alpine

WORKDIR /app

# Установка глобальных зависимостей
RUN npm install -g pnpm @nestjs/cli

# Копирование файлов зависимостей
COPY package*.json ./
COPY pnpm-lock.yaml* ./
COPY .pnpmrc* ./
COPY nest-cli.json tsconfig*.json ./

# Установка зависимостей (офлайн режим - использует локальные пакеты если доступны)
# В docker-compose node_modules монтируется как volume, поэтому для dev режима
# зависимости будут доступны через volume mount
RUN pnpm install --prefer-offline --no-verify-store-integrity || \
    echo "Warning: Some packages may be missing. Ensure node_modules are installed locally or mounted as volume."

# Копирование исходного кода
COPY . .

# Открываем порты для разных сервисов
EXPOSE 3000 3001 3003 3004 3005

# Команда по умолчанию (будет переопределена в docker-compose)
CMD ["node", "runner.js", "dev"]

